<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EMS Patient Simulator</title>
  <link rel="stylesheet" href="styles/style.css">
  <style>
    #chat-display {
      border: 1px solid #ccc;
      padding: 10px;
      height: 200px;
      overflow-y: auto;
      background: #f9f9f9;
    }
    #grading-output {
      white-space: pre-wrap;
    }
    #timer {
      font-size: 1.5rem;
      font-weight: bold;
      color: #d9534f;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1 style="text-align: center;">EMS Patient Simulator</h1>

  <div style="text-align: center; margin-bottom: 20px;">
    <a href="scenario-builder.html">
      <button style="padding: 10px 20px; font-size: 16px;">
        üß∞Ô∏è Go to Scenario Builder
      </button>
    </a>
  </div>

  <div style="text-align: center; margin-bottom: 20px;">
    <button id="start-button">üöë Start Scenario</button>
    <div id="timer"></div>
  </div>

  <div id="chat-interface">
    <h2>Patient Interaction</h2>
    <div id="chat-display"></div>
    <input type="text" id="user-input" placeholder="Ask the patient..." />
    <button id="send-button">Send</button>
  </div>

  <div style="text-align: center; margin-top: 20px;">
    <button id="end-scenario">üõë End Scenario</button>
  </div>
  <pre id="grading-output"></pre>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      let timerInterval;
      let timeRemaining = 900;
      let currentPatient = null;

      async function startScenario() {
        const chat = document.getElementById("chat-display");
        chat.innerHTML = "";
        try {
          console.log("Loading patient data...");
          const res = await fetch("./data/patients.json");
          if (!res.ok) throw new Error("Patient data not found!");
          const data = await res.json();
          currentPatient = data.patients[0];

          const dispatch = document.createElement("p");
          dispatch.textContent = `üìø Dispatch: Chief complaint is ${currentPatient.chiefComplaint}. Patient appears ${currentPatient.assessmentFindings.generalAppearance}.`;
          chat.appendChild(dispatch);

          startTimer();
        } catch (err) {
          console.error(err);
          chat.innerHTML = "<p>‚ö†Ô∏è Could not load patient.</p>";
        }
      }

      function startTimer() {
        clearInterval(timerInterval);
        timeRemaining = 900;
        const timerDisplay = document.getElementById("timer");

        timerInterval = setInterval(() => {
          const minutes = Math.floor(timeRemaining / 60);
          const seconds = timeRemaining % 60;
          timerDisplay.textContent = `‚è≥ Time Remaining: ${minutes}:${seconds.toString().padStart(2, '0')}`;

          if (timeRemaining <= 0) {
            clearInterval(timerInterval);
            timerDisplay.textContent = "‚è±Ô∏è Time's up!";
            generateGrading();
          }
          timeRemaining--;
        }, 1000);
      }

      function stopTimer() {
        clearInterval(timerInterval);
        document.getElementById("timer").textContent = "‚èπÔ∏è Timer stopped.";
      }

      function sendMessage() {
        const userText = document.getElementById("user-input").value.trim().toLowerCase();
        const chat = document.getElementById("chat-display");

        if (userText) {
          const userMessage = document.createElement("p");
          userMessage.textContent = `ü§ù You: ${userText}`;
          chat.appendChild(userMessage);

          const patientMessage = document.createElement("p");
          let reply = "I'm sorry, can you clarify your question?";

          if (currentPatient) {
            if (userText.includes("pain")) {
              reply = `Yes, it's ${currentPatient.opqrst.quality}. It's about ${currentPatient.opqrst.severity} out of 10 and started ${currentPatient.opqrst.onset}.`;
            } else if (userText.includes("medications") || userText.includes("medicine")) {
              reply = `I take ${currentPatient.sample.medications}.`;
            } else if (userText.includes("allergies")) {
              reply = `I am allergic to ${currentPatient.sample.allergies}.`;
            } else if (userText.includes("history")) {
              reply = `My medical history includes ${currentPatient.sample.pastMedicalHistory}.`;
            } else if (userText.includes("breathing")) {
              reply = `My breathing is ${currentPatient.assessmentFindings.breathing}.`;
            } else if (userText.includes("skin")) {
              reply = `My skin is ${currentPatient.vitals.skin}.`;
            } else if (userText.includes("pupils")) {
              reply = `My pupils are ${currentPatient.vitals.pupils}.`;
            } else if (userText.includes("event") || userText.includes("happened")) {
              reply = `I was ${currentPatient.sample.eventsLeadingTo}.`;
            }
          }

          patientMessage.textContent = `üßç Patient: ${reply}`;
          chat.appendChild(patientMessage);

          document.getElementById("user-input").value = "";
          chat.scrollTop = chat.scrollHeight;
        }
      }

      function generateGrading() {
        const studentActions = [
          "scene safety", "bsi", "number of patients", "als request",
          "oxygen via NRB", "vitals", "transport", "sample signs",
          "opqrst quality", "opqrst severity"
        ];

        const required = {
          scene: ["scene safety", "bsi", "number of patients", "moi/noi", "c-spine"],
          primary: ["general impression", "avpu", "airway", "breathing", "circulation", "transport"],
          history: ["sample signs", "sample allergies", "sample meds", "sample history", "sample last oral", "sample events"],
          opqrst: ["opqrst onset", "opqrst provocation", "opqrst quality", "opqrst region", "opqrst severity", "opqrst time"],
          vitals: ["vitals"],
          reassess: ["reassessment"]
        };

        const completed = [];
        const missed = [];
        const criticalFails = [];

        Object.entries(required).forEach(([section, steps]) => {
          steps.forEach(step => {
            if (studentActions.includes(step)) {
              completed.push(step);
            } else {
              missed.push(step);
              if (["airway", "breathing", "circulation", "scene safety"].includes(step)) {
                criticalFails.push(`${step} ‚Äî critical fail: life threat or safety not addressed`);
              }
            }
          });
        });

        const tips = [
          "Always address scene safety and life threats first.",
          "Memorize SAMPLE and OPQRST ‚Äî say them out loud to stay on track.",
          "Don‚Äôt skip reassessment ‚Äî it shows you're monitoring the patient.",
          "Treat airway, breathing, and circulation early if compromised."
        ];

        const output = `
‚úÖ Completed: ${completed.length}/${completed.length + missed.length}
${completed.map(x => "‚úîÔ∏è " + x).join("\n")}

‚ùå Missed:
${missed.map(x => "‚ùå " + x).join("\n")}

‚ö†Ô∏è Critical Fails:
${criticalFails.length ? criticalFails.map(x => "‚ö†Ô∏è " + x).join("\n") : "None"}

üåü Positive Feedback:
- Great job performing the following: ${completed.slice(0, 3).join(", ")}

üß† Tips to Improve:
${tips.slice(0, 4).map(t => "- " + t).join("\n")}
        `;

        document.getElementById("grading-output").textContent = output;
      }

      document.getElementById("start-button").addEventListener("click", startScenario);
      document.getElementById("send-button").addEventListener("click", sendMessage);
      document.getElementById("end-scenario").addEventListener("click", () => {
        stopTimer();
        generateGrading();
      });
    });
  </script>
</body>
</html>
