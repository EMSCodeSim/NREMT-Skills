<!-- Add this inside your <script> tag -->
<script>
  const chat = document.getElementById("chat");
  const input = document.getElementById("userInput");
  const micBtn = document.getElementById("micBtn");
  const endBtn = document.getElementById("endScenarioBtn");
  const startBtn = document.getElementById("startScenarioBtn");

  let recognition;
  let listening = false;
  let scenarioContext = "";
  let proctorContext = "";

  async function startScenario() {
    try {
      const dispatch = await fetch("/scenarios/chest_pain_001/dispatch.txt").then(r => r.text());
      appendMessage("Dispatch", dispatch);

      const patient = await fetch("/scenarios/chest_pain_001/patient.json").then(r => r.json());
      scenarioContext = `You are a ${patient.age}-year-old ${patient.sex} experiencing ${patient.chiefComplaint}. 
        The pain is ${patient.quality} in the ${patient.region}. Onset: ${patient.onset}, Severity: ${patient.severity}/10, Timing: ${patient.timing}. 
        Medical History: ${patient.medicalHistory.join(", ")}. Medications: ${patient.medications.join(", ")}. Allergies: ${patient.allergies.join(", ")}.`;

      const proctor = await fetch("/scenarios/chest_pain_001/proctor.json").then(r => r.json());
      proctorContext = proctor.instructions || "You are the proctor. Only answer when asked for vitals, scene info, or when user needs scoring feedback.";

      appendMessage("System", "Chest pain scenario loaded.");
      startBtn.disabled = true;
      startBtn.textContent = "Scenario Running...";
    } catch (err) {
      console.error("Scenario load failed", err);
      appendMessage("System", "Error loading scenario.");
    }
  }

  function appendMessage(sender, text) {
    const msg = document.createElement("div");
    msg.innerHTML = `<strong>${sender}:</strong> ${text}`;
    chat.appendChild(msg);
    chat.scrollTop = chat.scrollHeight;
  }

  async function sendMessage(textOverride) {
    const message = textOverride || input.value.trim();
    if (!message || (!scenarioContext && !proctorContext)) return;

    appendMessage("You", message);
    input.value = "";

    const role = message.toLowerCase().includes("blood pressure") || message.toLowerCase().includes("vitals")
      ? "proctor"
      : "patient";

    const response = await fetch("/.netlify/functions/openai", {
      method: "POST",
      body: JSON.stringify({
        message,
        role,
        context: role === "proctor" ? proctorContext : scenarioContext
      }),
    });

    const data = await response.json();
    appendMessage(role === "proctor" ? "Proctor" : "Patient", data.response);

    setTimeout(() => {
      if (listening) recognition.start();
    }, 1000);
  }

  function toggleMic() {
    if (!recognition) {
      recognition = new webkitSpeechRecognition();
      recognition.lang = "en-US";
      recognition.continuous = false;
      recognition.interimResults = false;

      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        sendMessage(transcript);
      };

      recognition.onend = () => micBtn.classList.remove("active");
    }

    if (!listening) {
      recognition.start();
      micBtn.classList.add("active");
      listening = true;
    } else {
      recognition.stop();
      micBtn.classList.remove("active");
      listening = false;
    }
  }

  function endScenario() {
    appendMessage("System", "Scenario ended.");
    input.disabled = true;
    micBtn.disabled = true;
    endBtn.disabled = true;
    startBtn.textContent = "Scenario Ended";
  }

  input.addEventListener("keydown", function (event) {
    if (event.key === "Enter" && !event.shiftKey) {
      event.preventDefault();
      sendMessage();
    }
  });
</script>
