<!-- Keep everything the same up to your <script> tag -->
<script>
  const chat = document.getElementById("chat");
  const input = document.getElementById("userInput");
  const micBtn = document.getElementById("micBtn");
  const endBtn = document.getElementById("endScenarioBtn");
  const startBtn = document.getElementById("startScenarioBtn");

  let recognition;
  let listening = false;
  let timerInterval;
  let timeRemaining = 15 * 60;
  let scenarioContext = '';

  async function loadScenario() {
    try {
      const res = await fetch("/scenarios/chest_pain_001/patient.json");
      const patient = await res.json();

      scenarioContext = `You are a ${patient.age}-year-old ${patient.sex} experiencing ${patient.chiefComplaint}. 
      The pain is ${patient.quality} in the ${patient.region}. Onset: ${patient.onset}, Severity: ${patient.severity}/10, Timing: ${patient.timing}. 
      Medical History: ${patient.medicalHistory.join(", ")}. Medications: ${patient.medications.join(", ")}. Allergies: ${patient.allergies.join(", ")}.`;

      console.log("Scenario context loaded.");
    } catch (err) {
      console.error("Failed to load scenario:", err);
    }
  }

  window.onload = loadScenario;

  function appendMessage(sender, text) {
    const msg = document.createElement("div");
    msg.innerHTML = `<strong>${sender}:</strong> ${text}`;
    chat.appendChild(msg);
    chat.scrollTop = chat.scrollHeight;
  }

  async function sendMessage(textOverride) {
    const message = textOverride || input.value.trim();
    if (!message) return;
    appendMessage("You", message);
    input.value = "";

    const response = await fetch("/.netlify/functions/openai", {
      method: "POST",
      body: JSON.stringify({ message, role: "patient", context: scenarioContext }),
    });
    const data = await response.json();
    appendMessage("Patient", data.response);

    setTimeout(() => {
      if (listening) recognition.start();
    }, 1000);
  }

  // ... (keep toggleMic, startScenario, endScenario unchanged)
</script>
