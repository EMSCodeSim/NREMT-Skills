<script>
  const inputBox = document.getElementById("inputBox");
  const messages = document.getElementById("messages");
  const startBtn = document.getElementById("startBtn");

  let simulationStarted = false;

  startBtn.addEventListener("click", () => {
    simulationStarted = true;
    appendMessage("You are responding to a 55-year-old male complaining of chest pain at a public park.", "ai");
  });

  inputBox.addEventListener("keypress", async function (e) {
    if (e.key === "Enter" && simulationStarted) {
      const text = inputBox.value.trim();
      if (!text) return;

      appendMessage(text, "user");
      inputBox.value = "";

      const payload = {
        message: text,
        role: "patient",
        context: "You are simulating a realistic EMS patient. Respond to EMT assessment questions like a real patient would."
      };

      console.log("üì§ Sending to Netlify function:", JSON.stringify(payload));

      try {
        const res = await fetch("/.netlify/functions/openai", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(payload)
        });

        const data = await res.json();
        console.log("üì• Received response:", data);
        appendMessage(data.response || "‚ö†Ô∏è No response received.", "ai");
      } catch (err) {
        console.error("‚ùå Fetch error:", err);
        appendMessage("‚ùå Error: " + err.message, "ai");
      }
    }
  });

  function appendMessage(text, role) {
    const div = document.createElement("div");
    div.className = "bubble " + role;
    div.textContent = text;
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
  }
</script>
